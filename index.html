<!doctype html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

    <style>
      body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: sans-serif;
        height: 100%;
        width: 100%;
      }

      /* Loading screen */
      #loading-screen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: #e5cfa3;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      #loading-icon {
        width: 50px;
        height: 50px;
        border: 4px solid #8b3d2e;
        border-top: 4px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% {transform: rotate(0deg);}
        100% {transform: rotate(360deg);}
      }

      /* Footer controls bar */
      #footer-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #e5cfa3;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 12px 0;
        z-index: 1000;
      }

      /* Circular capture button */
      #capture {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid white;
        background: #fff;
        box-shadow: 0 0 6px rgba(0,0,0,0.3);
      }

      /* Small buttons */
      .btn {
        background: none;
        border: none;
        color: black;
        font-size: 14px;
        cursor: pointer;
        padding: 6px 12px;
      }
    </style>
  </head>

  <body>
    <!-- Loading screen -->
    <div id="loading-screen">
      <div id="loading-icon"></div>
      <div>AR Marker Virtual Avatar</div>
    </div>

    <!-- Footer UI -->
    <div id="footer-bar">
      <button class="btn" id="switchCam">Switch</button>
      <button id="capture"></button>
      <button class="btn" id="share">Share</button>
    </div>

    <!-- AR Scene fills background -->
    <a-scene
      vr-mode-ui="enabled: false;"
      loading-screen="enabled: false;"
      renderer="logarithmicDepthBuffer: true;"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
      id="scene"
      embedded
      gesture-detector
      screenshot
      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
    >
      <a-assets>
        <a-asset-item
          id="animated-asset"
          src="assets/asset.gltf"
        ></a-asset-item>
      </a-assets>

      <a-marker
        id="animated-marker"
        type="pattern"
        preset="custom"
        url="assets/marker.patt"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
      >
        <!-- 3D Avatar -->
        <a-entity
          id="avatar"
          scale="1 1 1"
          animation-mixer="loop: repeat"
          gltf-model="#animated-asset"
          class="clickable"
          gesture-handler
        ></a-entity>

        <!-- Bio text attached to avatar -->
        <a-entity position="0 2 0">
          <a-plane 
            width="2.5" 
            height="0.6" 
            color="black" 
            opacity="0.6" 
            position="0 0 0" 
            material="shader: flat">
          </a-plane>
          <a-text 
            value="üë§ John Doe | AR Explorer" 
            align="center" 
            color="white" 
            position="0 0 0.01" 
            width="4">
          </a-text>
        </a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // Hide loading screen after scene is ready
      window.addEventListener("load", () => {
        document.getElementById("loading-screen").style.display = "none";
      });

      // Switch camera (front / back)
      let usingFrontCam = false;
      document.getElementById("switchCam").addEventListener("click", () => {
        usingFrontCam = !usingFrontCam;
        let scene = document.querySelector("a-scene");
        scene.setAttribute("arjs", `trackingMethod: best; sourceType: webcam; facingMode: ${usingFrontCam ? "user" : "environment"}`);
      });

      // Capture screenshot
      document.getElementById("capture").addEventListener("click", () => {
        let scene = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");
        let link = document.createElement("a");
        link.href = scene.toDataURL("image/png");
        link.download = "screenshot.png";
        link.click();
      });

      // Share screenshot via Web Share API
      document.getElementById("share").addEventListener("click", async () => {
        let scene = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");
        scene.toBlob(async (blob) => {
          let file = new File([blob], "screenshot.png", { type: "image/png" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: "Check out my AR Avatar!",
              text: "Here‚Äôs my AR experience üåê",
              files: [file],
            });
          } else {
            alert("Sharing not supported on this browser.");
          }
        });
      });
    </script>
  </body>
</html>

<!doctype html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

    <style>
      body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: sans-serif;
        height: 100%;
        width: 100%;
      }

      /* Loading screen */
      #loading-screen {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: #e5cfa3;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      #loading-icon {
        width: 50px;
        height: 50px;
        border: 4px solid #8b3d2e;
        border-top: 4px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% {transform: rotate(0deg);}
        100% {transform: rotate(360deg);}
      }

      /* Footer controls bar */
      #footer-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #e5cfa3;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 12px 0;
        z-index: 1000;
      }

      /* Circular capture button */
      #capture {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid white;
        background: #fff;
        box-shadow: 0 0 6px rgba(0,0,0,0.3);
      }

      /* Small buttons */
      .btn {
        background: none;
        border: none;
        color: black;
        font-size: 14px;
        cursor: pointer;
        padding: 6px 12px;
      }
    </style>
  </head>

  <body>
    <!-- Loading screen -->
    <div id="loading-screen">
      <div id="loading-icon"></div>
      <div>Loading AR Experience...</div>
    </div>

    <!-- Footer UI -->
    <div id="footer-bar">
      <button class="btn" id="switchCam">Switch</button>
      <button id="capture"></button>
      <button class="btn" id="share">Share</button>
    </div>

    <!-- Scene container -->
    <div id="scene-container"></div>

    <script>
      let usingFrontCam = false;

      function buildScene() {
        // remove old scene
        let oldScene = document.querySelector("a-scene");
        if (oldScene) oldScene.remove();

        // build new scene with correct camera
        let sceneHTML = `
          <a-scene
            vr-mode-ui="enabled: false;"
            loading-screen="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            embedded
            arjs="trackingMethod: best; sourceType: webcam; facingMode: ${usingFrontCam ? "user" : "environment"}; debugUIEnabled: false;"
            gesture-detector
            screenshot
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
          >
            <a-assets>
              <a-asset-item id="animated-asset" src="assets/asset.gltf"></a-asset-item>
            </a-assets>

            <!-- Marker -->
            <a-marker type="pattern" preset="custom" url="assets/marker.patt"
              raycaster="objects: .clickable" emitevents="true"
              cursor="fuse: false; rayOrigin: mouse;">
              
              <!-- Group: Avatar + Bio -->
              <a-entity id="avatar-group">
                <!-- Avatar -->
                <a-entity gltf-model="#animated-asset"
                  scale="1 1 1"
                  animation-mixer="loop: repeat"
                  class="clickable"
                  gesture-handler></a-entity>

                <!-- Bio fixed above avatar -->
                <a-entity position="0 2 0">
                  <a-plane width="2.8" height="0.6" color="black" opacity="0.6"></a-plane>
                  <a-text value="üë§ John Doe | AR Explorer"
                    align="center" color="white" position="0 0 0.01" width="4"></a-text>
                </a-entity>
              </a-entity>
            </a-marker>

            <a-entity camera></a-entity>
          </a-scene>
        `;

        document.getElementById("scene-container").innerHTML = sceneHTML;

        // hide loading after a delay
        setTimeout(() => {
          document.getElementById("loading-screen").style.display = "none";
        }, 2000);
      }

      // build initial scene
      window.addEventListener("load", () => {
        buildScene();
      });

      // Switch camera
      document.getElementById("switchCam").addEventListener("click", () => {
        usingFrontCam = !usingFrontCam;
        document.getElementById("loading-screen").style.display = "flex";
        buildScene();
      });

      // Capture screenshot (video + 3D overlay merged)
      document.getElementById("capture").addEventListener("click", () => {
        let sceneEl = document.querySelector("a-scene");
        if (!sceneEl) return;

        let videoEl = document.querySelector("video"); // AR.js webcam feed
        let canvas3D = sceneEl.components.screenshot.getCanvas("perspective");

        if (videoEl && canvas3D) {
          let finalCanvas = document.createElement("canvas");
          finalCanvas.width = videoEl.videoWidth;
          finalCanvas.height = videoEl.videoHeight;
          let ctx = finalCanvas.getContext("2d");

          // draw video frame
          ctx.drawImage(videoEl, 0, 0, finalCanvas.width, finalCanvas.height);

          // draw 3D render overlay
          ctx.drawImage(canvas3D, 0, 0, finalCanvas.width, finalCanvas.height);

          // download
          let link = document.createElement("a");
          link.href = finalCanvas.toDataURL("image/png");
          link.download = "screenshot.png";
          link.click();
        }
      });

      // Share screenshot
      document.getElementById("share").addEventListener("click", async () => {
        let sceneEl = document.querySelector("a-scene");
        if (!sceneEl) return;

        let videoEl = document.querySelector("video");
        let canvas3D = sceneEl.components.screenshot.getCanvas("perspective");

        if (videoEl && canvas3D) {
          let finalCanvas = document.createElement("canvas");
          finalCanvas.width = videoEl.videoWidth;
          finalCanvas.height = videoEl.videoHeight;
          let ctx = finalCanvas.getContext("2d");

          ctx.drawImage(videoEl, 0, 0, finalCanvas.width, finalCanvas.height);
          ctx.drawImage(canvas3D, 0, 0, finalCanvas.width, finalCanvas.height);

          finalCanvas.toBlob(async (blob) => {
            let file = new File([blob], "screenshot.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({
                title: "Check out my AR Avatar!",
                text: "Here‚Äôs my AR experience üåê",
                files: [file],
              });
            } else {
              alert("Sharing not supported on this browser.");
            }
          });
        }
      });
    </script>
  </body>
</html>
